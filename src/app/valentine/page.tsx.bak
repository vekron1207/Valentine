"use client";

import { useEffect, useState, useRef } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import ValentinePrompt from "@/components/ValentinePrompt";
import FloatingHearts from "@/components/FloatingHearts";
import BackgroundMusic from "@/components/BackgroundMusic";

export default function ValentinePage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const name = searchParams.get("name");
  const celebrationAudioRef = useRef<HTMLAudioElement>(null);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    if (!name) {
      router.replace("/");
    }
  }, [name, router]);

  const handleYes = () => {
    if (celebrationAudioRef.current) {
      celebrationAudioRef.current.volume = 0.6;
      celebrationAudioRef.current.play().catch(() => {});
    }
    router.push(`/confirmation?name=${encodeURIComponent(name || "")}`);
  };

  if (!mounted || !name) return null;

  return (
    <main className="mesh-bg relative min-h-dvh flex items-center justify-center overflow-hidden">
      <audio ref={celebrationAudioRef} preload="auto">
        <source src="/letsgetitOn.mp3" type="audio/mpeg" />
      </audio>
      <FloatingHearts />
      <BackgroundMusic />
      <div className="relative z-10 px-5 py-8">
        <ValentinePrompt name={name} onYes={handleYes} />
      </div>
    </main>
  );
}
